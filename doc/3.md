来看一下客户端实现的细节，这里主要说和服务端消息服务通信部分的。

首先底层API暴露出的功能有：

- 发送消息
    - 发送业务消息
    - 发送Sync，Box，Auth这三种逻辑消息
- 接收消息
    - 接收业务消息
    - 接收Sync，Box，Auth这三种逻辑消息
- 发起连接
    - 传递服务端地址并创建连接，API本身不会做IP:PORT获取
    - 在发生断线时重新发起连接
- 关闭连接
    - 主动退出关闭连接
    - 崩溃时/异常时/无法处理的错误时关闭连接并退出

而底层API本身需要做的事除了暴露上述API，还包括：

- 心跳逻辑：自动发送Ping并处理Pong
- 断线自动重连：保存上一次连接地址并尝试连接
- 处理下线消息：通知上层并等待新的连接
- 转发ACK
- 处理错误消息：包括反馈给上层API
- 存储消息：持久化消息，方便查询
- 记录系统最新状态：用于Sync

这里有一个问题，就是怎么实现发送失败通知，假如设定超时时间为三秒，则三秒之后未收到ACK则认为发生失败，难点在于怎么实现三秒后的查询。

如果使用定时器，则对定时器性能要求比较高，如果不使用则需要使用循环查询+下次唤醒机制。

关于ACK未收到分为发送失败和ACK回复失败两种，前者简单重发即可(但是可能造成消息顺序错乱，QQ就存在这个问题，所以我们也不管了)，后者重发会造成消息重复，这一点只能让服务端去判断(哈希消息保存+Set记录+过期时间设定)。

所以消息发送幂等由服务端实现。

这里选用定时器实现。性能什么的不管了，应该问题不大。其实如果选用轮询的话，可以使用定时处理，这样保证最多两个Ticker之内可以处理消息超时问题。

关于记录消息ACK选用下标数组实现，这里就有一个假设，即一毫秒内不会产生两条消息。